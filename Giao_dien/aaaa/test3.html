<!DOCTYPE html>
<html>
  <head>
    <title>OpenLayers Map Example</title>
    
    <link rel="stylesheet" href="https://openlayers.org/en/v4.6.5/css/ol.css" type="text/css">
    <script src="https://openlayers.org/en/v4.6.5/build/ol.js" type="text/javascript"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css"/>

    <!-- <script src="js.js"></script>
    <script src="js2.js"></script> -->
   <style>
      #result input{
        width: 650px;
      }
      .map{
        width: 100%; 
        height: 500px;
      }
   </style>
  </head>
  <body onload="initMap()">
    <div id="map" class="map"></div>
    <input id="search" type="text" placeholder="Tìm kiếm địa điểm">
    <div id="result" style="color: aqua;"></div>
    <div id="dinhvi"></div>
    
    <script>
      var map; // Khai báo biến map ở đầu file js.js

      function initMap() {
        // Thiết lập bản đồ
        map = new ol.Map({
          target: 'map',
          layers: [
            new ol.layer.Tile({
              source: new ol.source.OSM(),
            }),
          ],
        });
        
        // ------------------------------
        if ('geolocation' in navigator) {
          navigator.geolocation.getCurrentPosition(function(position) {
            var pos = ol.proj.fromLonLat([position.coords.longitude, position.coords.latitude]);
            var data = {
              latitude: position.coords.latitude,
              longitude: position.coords.longitude
            };
            $.ajax({
              type: 'POST',
              url: '/api/location',
              data: JSON.stringify(data),
              contentType: 'application/json',
              success: function() {
                console.log('Đã gửi vị trí đến máy chủ');
              }
            });
            var marker = new ol.Feature({
              geometry: new ol.geom.Point(pos)
            });
            var markerSource = new ol.source.Vector({
              features: [marker]
            });
            var markerLayer = new ol.layer.Vector({
              source: markerSource
            });
            map.addLayer(markerLayer);
            map.getView().setCenter(pos);
            map.getView().setZoom(15);
          });
        } else {
          alert('Định vị địa lý không được trình duyệt của bạn hỗ trợ');
        }
        // ------------------------------
      
        // Thêm control để xác định vị trí hiện tại
        var geolocation = new ol.Geolocation({
          trackingOptions: {
            enableHighAccuracy: true
          },
          projection: map.getView().getProjection()
        });
        var positionFeature = new ol.Feature();
        positionFeature.setStyle(new ol.style.Style({
          image: new ol.style.Circle({
            radius: 6,
            fill: new ol.style.Fill({
              color: '#3399CC'
            }),
            stroke: new ol.style.Stroke({
              color: '#fff',
              width: 2
            })
          })
        }));
      
        //----------------------------------------
        
      
      
      
        // Tạo một đối tượng marker
          var marker = new ol.Feature({
            geometry: new ol.geom.Point(ol.proj.fromLonLat([0, 0]))
        });
        marker.setStyle(new ol.style.Style({
            image: new ol.style.Icon({
            anchor: [0.5, 1],
            src: 'https://openlayers.org/en/latest/examples/data/icon.png'
            })
        }));
      
        // Thêm marker vào bản đồ
        var markerLayer = new ol.layer.Vector({
            source: new ol.source.Vector({
            features: [marker]
            })
        });
        map.addLayer(markerLayer);
      
        // Xử lý thông tin địa điểm khi click vào bản đồ
          map.on('singleclick', function (evt) {
            var clickedCoordinate = evt.coordinate;
            var lonlat = ol.proj.toLonLat(clickedCoordinate);
      
            // Di chuyển marker tới vị trí click
            marker.getGeometry().setCoordinates(clickedCoordinate);
            handlePosition(lonlat, evt, clickedCoordinate);
        });
        
        
        function handlePosition(lonlat, evt) {
          // Tìm kiếm địa điểm gần vị trí chọn nhất và hiển thị thông tin lên bản đồ
          var url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lonlat[1]}&lon=${lonlat[0]}`;
          fetch(url)
              .then(response => response.json())
              .then(data => {
              console.log(data);
              var result = document.getElementById("result");
              if (result) {
                  result.innerHTML = `<h1>Địa điểm bạn đã chọn:</h1>
                  <input type="text" placeholder="" value="${data.display_name}" name="">`;
              } else {
                  console.log("Không tìm thấy phần tử có ID 'kết quả'");
              }
              })
              .catch(error => {
              console.error("Lỗi khi tìm nạp dữ liệu:", error);
              });
      
        }
      
          // Thêm control zoom slider
          var zoomSlider = new ol.control.ZoomSlider();
          map.addControl(zoomSlider);
      
          // Thêm control full screen
          var fullScreen = new ol.control.FullScreen();
          map.addControl(fullScreen);
      
      }


      
    var searchBtn = document.getElementById("search-btn");
    searchBtn.addEventListener("click", searchAddress);

    function searchAddress() {
      var address = document.getElementById("search").value;
      var url = "https://nominatim.openstreetmap.org/search?q=" + address + "&format=json";
      fetch(url)
        .then(function (response) {
          return response.json();
        })
        .then(function (data) {
          // Hiển thị kết quả tìm kiếm trên bản đồ
          showSearchResults(data);
        })
        .catch(function (error) {
          console.log(error);
        });
    }
    
    function showSearchResults(data) {
      // Xóa tất cả các marker trên bản đồ
      markerLayer.getSource().clear();
    
      // Hiển thị kết quả tìm kiếm trên bản đồ
      if (data.length > 0) {
        var searchResult = data[0];
        var searchResultCoord = ol.proj.fromLonLat([searchResult.lon, searchResult.lat]);
        var searchResultMarker = new ol.Feature({
          geometry: new ol.geom.Point(searchResultCoord),
        });
        searchResultMarker.setStyle(
          new ol.style.Style({
            image: new ol.style.Icon({
              src: "https://openlayers.org/en/latest/examples/data/icon.png",
            }),
          })
        );
        markerLayer.getSource().addFeature(searchResultMarker);
        map.getView().setCenter(searchResultCoord);
        map.getView().setZoom(15);
      }
    }

    // Tạo một control tìm kiếm địa điểm trên bản đồ
var searchControl = new L.Control.Search({
    position: 'topleft',
    layer: markerLayer,
    propertyName: 'name',
    initial: false,
    zoom: 15,
    marker: false,
    textPlaceholder: 'Tìm kiếm địa điểm...',
    moveToLocation: function (latlng, title, map) {
      // Di chuyển marker tới vị trí được chọn
      marker.getGeometry().setCoordinates(latlng);
      // Hiển thị thông tin địa điểm lên bản đồ
      var popup = new ol.Overlay.Popup();
      map.addOverlay(popup);
      popup.show(latlng, '<div>' + title + '</div>');
    }
  });
  map.addControl(searchControl);
  
  // Xử lý sự kiện khi tìm kiếm địa điểm
  searchControl.on('search:locationfound', function (e) {
    // Lấy thông tin về địa điểm được chọn
    var result = e.text.split(',');
    var name = result[0];
    var lat = e.latlng.lat;
    var lon = e.latlng.lng;
    var pos = ol.proj.fromLonLat([lon, lat]);
  
    // Di chuyển marker tới vị trí được chọn
    marker.getGeometry().setCoordinates(pos);
  
    // Hiển thị thông tin địa điểm lên bản đồ
    var popup = new ol.Overlay.Popup();
    map.addOverlay(popup);
    popup.show(pos, '<div>' + name + '</div>');
  });
  
  // Xử lý sự kiện
  def search():
  # Lấy từ khóa tìm kiếm
  keyword = search_box.get()

  # Tìm kiếm trong danh sách sản phẩm
  results = []
  for product in products:
      if keyword.lower() in product['name'].lower():
          results.append(product)

  # Hiển thị kết quả
  show_products(results)  
    </script>
  </body>
</html>
