<!DOCTYPE html>
<html>
<head>
    <title>@Page.Title</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="shortcut icon" href="~/Style/img/avt/logo.jpg">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
          integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w=="
          crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
          integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w=="
          crossorigin="anonymous" referrerpolicy="no-referrer" />

    <link href="~/Style/css/html/trangchu.css" rel="stylesheet" />
    <link href="~/Style/css/layout/onee.css" rel="stylesheet" />
    <link href="~/Style/css/layout/two.css" rel="stylesheet" />
    <link href="~/Style/css/layout/modall.css" rel="stylesheet" />
    <link href="~/Style/css/layout/menu__login.css" rel="stylesheet" />
    @RenderSection("head", required: false)
</head>
<body>
    <div class="header">

        <nav class="header__nav">
            <div class="header__nav__container">
                <div class="grid wide">
                    <div class="row">
                        <div class="l-3 m-6 c-8">
                            <a href="#">
                                <div class="header__nav__container--logo">
                                    Jade dradon
                                </div>
                            </a>
                        </div>
                        <div class="l-6 hide-on-tablet_mobile">
                            <ul class="header__nav__container--list">
                                <li><a href="@Url.Action("trangchu", "trangchu")">Trang chủ</a></li>
                                <li>
                                    <a href="@Url.Action("khachsan", "khachsan", new {ma = Session["MaKhachSanPhong"],
                                          batdau = Session["batdau"], ketthuc = Session["ketthuc"]})">
                                        Khách sạn
                                    </a>
                                </li>
                                <li><a href="@Url.Action("nhanxet", "nhanxet")">Nhận xét</a></li>
                                <li><a href="@Url.Action("chat", "TinNhan", new {makh = Session["MaKh"]})">Nhắn tin</a></li>
                            </ul>
                        </div>

                        <div class="l-3 m-6 c-4 top">
                            <i class="fas fa-bars list-tablet-mobile" id="menu_open"></i>
                            @if (Session["SESSION_GROUP"] != null)
                            {
                                List<string> privilegeLevels = (List<string>)Session["SESSION_GROUP"];

                                if (privilegeLevels[0].CompareTo("Client") == 0)
                                {
                                    <div class="header__nav__container--search">
                                        <div class="a">
                                            <img src="~/UpLoad_Img/KhachHang/@Session["Avt"]" alt="" class="avt" title="@Session["HoTen"]">
                                            <ul>
                                                <li class="User--a">
                                                    <a href="@Url.Action("TrangCaNhan", "User", new {id = Session["MaKh"] })">
                                                        Trang cá nhân
                                                    </a>
                                                </li>
                                                <li><a href="@Url.Action("SignUpp", "Account", new { area = "Admin" })">Đăng ký</a></li>
                                                <li><a href="@Url.Action("QuenMatKhau", "User", new {id = Session["MaKh"] })">Quên mật khẩu</a></li>
                                                <li>
                                                    <a href="@Url.Action("SignOut", "Account", new { area = "Admin" })">
                                                        Đăng xuất
                                                    </a>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    <div class="header__nav__container--search">
                                        <div class="a">
                                            <a href="@Url.Action("Login", "Account", new { area = "Admin" })">
                                                <img src="~/Style/img/icon/icon_Login.jpg" class="avt" title="Login" />
                                            </a>
                                            <a href="@Url.Action("SignUpp", "Account", new { area = "Admin" })">
                                                <img src="~/Style/img/icon/icon_SignUp.jpg" class="avt" title="SignUp" />
                                            </a>
                                        </div>
                                    </div>
                                }
                            }
                            else
                            {
                                <div class="header__nav__container--search">
                                    <div class="a">
                                        <a href="@Url.Action("Login", "Account", new { area = "Admin" })">
                                            <img src="~/Style/img/icon/icon_Login.jpg" class="avt" />
                                        </a>
                                        <a href="@Url.Action("SignUpp", "Account", new { area = "Admin" })">
                                            <img src="~/Style/img/icon/icon_SignUp.jpg" class="avt" />
                                        </a>
                                    </div>
                                </div>
                            }
                        </div>

                    </div>
                </div>
            </div>
        </nav>

        <div class="header__menu">
            <div class="header__menu__overlay"></div>
            <div class="header__menu__body--content">
                <ul>
                    <li><a href="@Url.Action("trangchu", "trangchu")">Trang chủ</a></li>
                    <li>
                        <a href="@Url.Action("khachsan", "khachsan", new {ma = Session["MaKhachSanPhong"],
                                batdau = Session["batdau"], ketthuc = Session["ketthuc"]})">
                            Khách sạn
                        </a>
                    </li>
                    <li><a href="@Url.Action("nhanxet", "nhanxet")">Nhận xét</a></li>
                    <li><a href="@Url.Action("chat", "TinNhan", new {makh = Session["MaKh"]})">Nhắn tin</a></li>

                </ul>
                <i class="fas fa-times" id="menu_close"></i>
            </div>
        </div>
        <div class="scroll-top">
            <i class="fas fa-arrow-up"></i>
        </div>
    </div>
    @RenderBody()
    <nav class="nav"></nav>
    <div class="footer">
        <div class="end">
            <div class="name">
                <h1>JADE DRAGON</h1>
            </div>
            <div class="logo">
                <img src="~/Style/img/avt/logo.jpg" />
            </div>
        </div>
    </div>
    <script src="~/Style/js/GiaoDienChat.js"></script>
    <script>
        window.addEventListener('load', function () {
            var danhmucsp = document.getElementById('danhmucsp');
            danhmucsp.scrollIntoView({ behavior: 'smooth' });
        });
    </script>

    @if (TempData["WebMsgBox"] != null && (bool)TempData["WebMsgBox"] == true)
    {
        <script type="text/javascript">
        alert('@Html.Raw(TempData["Message"])');
        </script>
    }

    <script src="~/Scripts/jquery-1.10.2.js"></script>
    <script src="~/Scripts/jquery.signalR-2.4.3.min.js"></script>
    <script src="~/signalr/hubs"></script>

    <script>
        $(function () {
            var chat = $.connection.chat;
            loadClient(chat);
            var idphong = 1;
            $.connection.hub.start().done(function () {
                $('#btnSend').click(function () {
                    sendMessage(chat);
                });

                $('.btnChatPhong').click(function () {
                    var roomId = $(this).data('id');
                    var tenphong = $(this).text();
                    ChatAdmin(chat, roomId, tenphong);
                });

                // Xử lý sự kiện nhấn phím Enter để gửi tin nhắn
                $('#txtMessage').keypress(function (e) {
                    if (e.which === 13) { // Kiểm tra xem phím Enter đã được bấm chưa
                        sendMessage(chat);
                    }
                });

                // Lấy danh sách tin nhắn trong phòng chat và hiển thị lên
                var roomId = $('#idphong').val();
                chat.server.getMessages(roomId);
            });
        });

        function sendMessage(chat) {
            var roomId = $('#idphong').val();
            var msg = $('#txtMessage').val();
            var makh = $('#makh').val();
            chat.server.message(roomId, makh, msg);
            $('#txtMessage').val('').focus();
        }

        function ChatAdmin(chat, roomId, tenphong) {
            $('#idphong').val(roomId);
            $('#tenphong').text(tenphong);
            $('#contentMsg li').hide(); // hide all messages
            $('#contentMsg li.admin').show(); // show only admin messages
            chat.server.getMessages(roomId);
        }

        /*-----------------------------------------------*/

        var lastSenderId = null; // khởi tạo biến lưu trữ mã khách hàng ở vòng trước
        var lastMessageTime = null; // khởi tạo biến lưu trữ thời gian tin nhắn cuối cùng

        function loadClient(chat) {
            chat.client.message = function (tenphong, name, msg, makh, ngaygui) {
                var li = "";
                var me = "me";
                var you = "you";
                var messageTime = new Date(ngaygui).getTime(); // chuyển đổi ngày gửi tin nhắn thành thời gian (đơn vị: milliseconds)

                // Kiểm tra nếu đã đủ 1 giờ kể từ lần gửi tin nhắn cuối cùng
                if (lastMessageTime && (messageTime - lastMessageTime) >= (60 * 60 * 1000)) {
                    // Nếu đã đủ 1 giờ, in ra thời gian của tin nhắn mới
                    var messageDate = new Date(messageTime);
                    var messageDateString = messageDate.toLocaleString();
                    var messageTimeHTML = '<p class= "timenow" >' + messageDateString + '</p>';
                    $('#contentMsg').append(messageTimeHTML);
                }

                if (makh == $('#makh').val()) { // người gửi tin nhắn là người dùng đang truy cập
                    li = "<li data-sender='" + makh + "' class = '" + me + "' ><span>" + msg + "</span></li>";
                } else {
                    li = "<li data-sender='" + makh + "' class = '" + you + "' ><p>"
                        + (makh !== lastSenderId ? name + ":" : "") + "</p> <span>"
                        + msg + "</span></li>";
                }
                $('#contentMsg').append(li);

                lastSenderId = makh; // lưu mã khách hàng hiện tại cho lần so sánh ở vòng sau
                lastMessageTime = messageTime; // lưu lại thời gian gửi tin nhắn cuối cùng

                // Cuộn thanh cuộn xuống tin nhắn mới nhất
                var messagesContainer = $('#contentMsg');
                messagesContainer.scrollTop(messagesContainer[0].scrollHeight);
            }
        }



    </script>  

</body>
</html>
