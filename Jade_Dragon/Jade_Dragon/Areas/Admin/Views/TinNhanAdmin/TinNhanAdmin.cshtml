@model Jade_Dragon.Models.Chat_Admin

@{
    ViewBag.Title = "TinNhanAdmin";
    Layout = "~/Areas/Admin/Views/Shared/LayoutAdmin.cshtml";
}
<link href="~/Areas/Admin/Public/css/css_ChatAdmin.css" rel="stylesheet" />

<style>
    .body-send-chat button.txtchat {
        width: 60px;
    }
    .body-send-chat button.txtchat img {
        height: 100%;
    }

    .body-send-chat button.txtchat:hover img {
        width: 40px;
    }
    /*------Hiển thị hình ảnh----------*/
    .body-send-chat .fileInputWrapper {
        position: relative;
        display: inline-block;
        cursor: pointer;
        z-index: 999;
        margin-left: -112px;
        margin-top: 65px;
        border: 1px solid black;
        padding: 0px 10px 0px 10px;
        height: 36px;
    }

    .body-send-chat .fileInputIcon {
        width: 30px;
        height: 30px;
        object-fit: contain;
    }

    .body-send-chat input[type="file"] {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        visibility: hidden;
        cursor: pointer;
    }
</style>
<style>
    .body-item-chat .htchat ul::-webkit-scrollbar {
        width: 10px;
        transition: width 0.5s ease-in-out;
    }

    .body-item-chat .htchat ul:hover::-webkit-scrollbar {
        width: 25px;
    }

    .body-item-chat .htchat #contentMsg li img {
        max-width: 150px;
        max-height: 150px;
        border: 1px solid black;
    }
    .body-item-chat .htchat {
        height: 73vh;
    }
</style>

<div class="home">
    <div class="body">
        <div class="body-chat">
            <div class="body-item-chat">
                <div class="list-chat">
                    <div style="height: 5%;"></div>
                    <div class="list-Group list-chat-a">
                        <span>Nhóm chat</span>
                        <ul id="Create_Room">
                            <li class="Show">
                                <button type="submit" id="Create">
                                    <img src="~/Style/img/icon/icon-them.jpg" style="width: 20px;" />
                                </button>
                            </li>
                            <li class="Create-new">
                                <input type="text" placeholder="Tạo nhóm mới" class="input" id="txtCreate" />
                                <button type="submit" class="button">Thêm</button>
                            </li>
                        </ul>
                    </div>
                    <div class="list-User list-chat-a">
                        <span>Khách hàng</span>
                        <ul>
                            @foreach (var dem in Model.kh)
                            {
                                <li>
                                    <button type="submit" class="btnUser" data-id="@dem.MaKh">
                                        @dem.HoTen
                                    </button>
                                </li>
                            }
                        </ul>
                    </div>
                </div>
                <div class="htchat">
                    <div id="tenphong">@Session["TenPhong"]</div>
                    <input type="hidden" id="idphong" value="@Session["MaPhong"]" />
                    <input type="hidden" id="idUser" value="" />

                    <ul id="contentMsg"></ul>
                </div>
            </div>
            <div class="body-send-chat">
                <input type="hidden" id="makh" value="@Session["MaKh"]" />

                <input type="text" id="txtMessage" placeholder="Nhập chat" class="txtchat" />
                <button type="submit" id="btnSend" class="txtchat">
                    <img src="~/Style/img/icon/Icon-Send2.png" />
                </button>
                <label for="fileInput" class="fileInputWrapper">
                    <img src="~/Style/img/icon/Icon_Img.jpg" alt="Upload Image" class="fileInputIcon">
                    <input id="fileInput" type="file" accept="image/*">
                </label>
            </div>
        </div>
    </div>
</div>

<script src="~/Scripts/jquery-1.10.2.js"></script>
<script src="~/Scripts/jquery.signalR-2.4.3.min.js"></script>
<script src="~/signalr/hubs"></script>
@*<script src="~/Areas/Admin/Public/js/Chat_Admin.js"></script>*@

<script>
    $(function () {
        var chat = $.connection.chat;
        loadClient(chat);
        loadDelete(chat);
        loadGroup(chat);
        document.querySelector('.Create-new').classList.add('hidden');

        $.connection.hub.start().done(function () {
            console.log("check", $('.btnChatPhong'))
            $('#btnSend').click(function () {
                sendMessage(chat);
            });

            $('.btnUser').click(function () {
                var MaNguoiNhan = $(this).data('id');
                var TenNguoiNhan = $(this).text();
                var MaNguoiGui = $('#makh').val();
                ChatUser(chat, MaNguoiNhan, TenNguoiNhan, MaNguoiGui);
            });

            // Đổi phòng
            $('#Create_Room').on("click", "button", (function () {
                var roomId = $(this).data('id');

                var tenphong = $(this).text();
                ChatGroup(chat, roomId, tenphong);
            }));

            // CHuyển sang tạo mới phòng
            $('#Create').click(function () {
                document.querySelector('.Show').classList.add('hidden');
                document.querySelector('.Create-new').classList.remove('hidden');
            });

            // Tạo mới phòng
            $('.button').click(function () {
                CreateGroup(chat);
            });

            // Xử lý sự kiện nhấn phím Enter để gửi tin nhắn
            $('#txtMessage').keypress(function (e) {
                if (e.which === 13) { // Kiểm tra xem phím Enter đã được bấm chưa
                    sendMessage(chat);
                }
            });

            $('#txtCreate').keypress(function (e) {
                if (e.which === 13) { // Kiểm tra xem phím Enter đã được bấm chưa
                    CreateGroup(chat);
                }
            });

            // Lấy danh sách tin nhắn trong phòng chat và hiển thị lên
            var roomId = $('#idphong').val();
            if (roomId == null || roomId.trim() == '') {
                var idnhan = $('#idUser').val();
                var idgui = $('#makh').val();
                chat.server.getMessagesAdmin(idnhan, idgui);
            } else {
                chat.server.getMessages(roomId);
            }

            //Lấy danh sách phòng
            chat.server.getTaoMoi();

            // Xóa tin nhắn
            $('#contentMsg').on("click", "button#deleteButton", (function () {
                var matn = $(this).data('id');
                var nguoigui = $(this).data('gui');
                var khachhang = $(this).data('makh');
                chat.server.deleteTinNhan(matn, nguoigui, khachhang);
            }));
        });
    });

    function sendMessage(chat) {
        var roomId = $('#idphong').val();
        var IdNhan = $('#idUser').val();
        var msg = $('#txtMessage').val();
        var makh = $('#makh').val();
        var fileInput = document.getElementById('fileInput');
        if ((msg == null || msg.trim() == '') && (fileInput.files.length <= 0)) {
            // Nếu msg và file input đều rỗng
            return;
        }
        // Nếu file input không rỗng
        if (fileInput.files.length > 0) {
            for (var i = 0; i < fileInput.files.length; i++) {
                var file = fileInput.files[i];
                if (file.size > (10 * 1024 * 1024)) {
                    /*var fileSizeMB = (file.size / (1024*1024)).toFixed(2);*/
                    alert('Dung lượng ảnh cho phép tải lên chỉ tối đa 10MB \n' +
                        'Ảnh Bạn đang tải là: ' + file.size + 'MB');
                    return;
                }
                var reader = new FileReader();
                reader.onload = function (e) {
                    if (msg == null || msg.trim() == '') {
                        if (roomId == null || roomId.trim() == '') {
                            chat.server.message(IdNhan, makh, null, e.target.result, true);
                        } else {
                            chat.server.message(roomId, makh, null, e.target.result, false);
                        }
                    } else {
                        if (roomId == null || roomId.trim() == '') {
                            chat.server.message(IdNhan, makh, msg, e.target.result, true);
                        } else {
                            chat.server.message(roomId, makh, msg, e.target.result, false);
                        }
                    }
                    // Clear file input.
                    fileInput.value = '';
                };
                reader.readAsDataURL(file);
            }
        } else {
            // Call the message method on the hub with isPrivate = false.
            chat.server.message(roomId, makh, msg, null, false);
        }
        // Clear message input.
        $('#txtMessage').val('').focus();
    }

    function ChatGroup(chat, roomId, tenphong) {
        $('#idphong').val(roomId);
        $('#tenphong').text(tenphong);
        $('#contentMsg p').hide();
        $('#contentMsg li').hide(); // hide all messages
        $('#contentMsg li.admin').show(); // show only admin messages

        chat.server.getMessages(roomId);
    }

    function ChatUser(chat, MaNguoiNhan, TenNguoiNhan, MaNguoiGui) {

        $('#idphong').val("");
        $('#idUser').val(MaNguoiNhan);
        $('#tenphong').text(TenNguoiNhan);
        $('#contentMsg p').hide();
        $('#contentMsg li').hide(); // hide all messages
        $('#contentMsg li.admin').show(); // show only admin messages

        chat.server.getMessagesAdmin(MaNguoiNhan, MaNguoiGui);
    }

    function CreateGroup(chat) {
        var room_new = $('#txtCreate').val();

        if (confirm("Bạn chắc chắn sẽ tạo phòng này?")) {
            if (room_new.length > 25) {
                alert("Tên phòng không được vượt quá 25 ký tự!");
                return;
            }
            chat.server.taoMoi(room_new);
            document.querySelector('.Create-new').classList.add('hidden');
            document.querySelector('.Show').classList.remove('hidden');
            $('#txtCreate').val('').focus();
        } else {
            // Do nothing if the user clicked "Cancel" in the confirmation dialog
            return;
        }
    }


    /*-----------------------------------------------*/

    var lastSenderId = null; // khởi tạo biến lưu trữ mã khách hàng ở vòng trước
    var lastMessageTime = null; // khởi tạo biến lưu trữ thời gian tin nhắn cuối cùng

    function loadClient(chat) {

        chat.client.message = function (name, msg, makh, ngaygui, matinnhan, imageUrl) {
            var MaKhachHang = $('#makh').val();
            var li = "";
            var messageTime = new Date(ngaygui).getTime();
            var linkanh = "/Style/img/icon/icon-X.jpg";

            // Kiểm tra nếu đã đủ 1 giờ kể từ lần gửi tin nhắn cuối cùng
            if (lastMessageTime && (messageTime - lastMessageTime) >= (60 * 60 * 1000)) {
                // Nếu đã đủ 1 giờ, in ra thời gian của tin nhắn mới
                var messageDate = new Date(messageTime);
                var messageDateString = messageDate.toLocaleString();
                var messageTimeHTML = '<p class= "timenow" >' + messageDateString + '</p>';
                $('#contentMsg').append(messageTimeHTML);

                if (makh == $('#makh').val()) { // người gửi tin nhắn là người dùng đang truy cập
                    li = "<li data-sender='" + makh + "' class = 'me' >" +
                        "<div class='Delete'><button type='button' id='deleteButton' data-id='" + matinnhan + "' data-gui='" + makh + "' data-makh='" + MaKhachHang + "'>" +
                        "<img src='" + linkanh + "' title='Xóa tin nhắn'/>" +
                        "</button></div > " +
                        (msg ? "<span>" + msg + "</span>" : "") +
                        (imageUrl ? '<br/><img src="' + imageUrl + '" />' : '') + "</li>";
                } else {
                    li = "<li data-sender='" + makh + "' class = 'you' ><p>"
                        + name + "</p>" +
                        "<div class='Delete'><button type='button' id='deleteButton' data-id='" + matinnhan + "' data-gui='" + makh + "' data-makh='" + MaKhachHang + "'>" +
                        "<img src='" + linkanh + "' title='Xóa tin nhắn'/>" +
                        "</button></div > " +
                        (msg ? "<span>" + msg + "</span>" : "") +
                        (imageUrl ? '<br/><img src="' + imageUrl + '" />' : '') + "</li>";
                }
                $('#contentMsg').append(li);
            } else {
                if (makh == $('#makh').val()) { // người gửi tin nhắn là người dùng đang truy cập
                    li = "<li data-sender='" + makh + "' class = 'me' >" +
                        "<div class='Delete'><button type='button' id='deleteButton' data-id='" + matinnhan + "' data-gui='" + makh + "' data-makh='" + MaKhachHang + "'>" +
                        "<img src='" + linkanh + "' title='Xóa tin nhắn'/>" +
                        "</button></div > " +
                        (msg ? "<span>" + msg + "</span>" : "") +
                        (imageUrl ? '<br/><img src="' + imageUrl + '" />' : '') + "</li>";
                } else {
                    li = "<li data-sender='" + makh + "' class = 'you' ><p>"
                        + (makh !== lastSenderId ? name + ":" : "") + "</p>" +
                        "<div class='Delete'><button type='button' id='deleteButton' data-id='" + matinnhan + "' data-gui='" + makh + "' data-makh='" + MaKhachHang + "'>" +
                        "<img src='" + linkanh + "' title='Xóa tin nhắn'/>" +
                        "</button></div > " +
                        (msg ? "<span>" + msg + "</span>" : "") +
                        (imageUrl ? '<br/><img src="' + imageUrl + '" />' : '') + "</li>";
                }
                $('#contentMsg').append(li);
            }

            lastSenderId = makh; // lưu mã khách hàng hiện tại cho lần so sánh ở vòng sau
            lastMessageTime = messageTime; // lưu lại thời gian gửi tin nhắn cuối cùng

            var hasImage = imageUrl !== null && imageUrl !== '';
            if (hasImage) {
                setTimeout(function () {
                    var messagesContainer = $('#contentMsg');
                    messagesContainer.scrollTop(messagesContainer[0].scrollHeight);
                }, 500); // chờ 500ms để hình ảnh được tải xong
            } else {
                var messagesContainer = $('#contentMsg');
                messagesContainer.scrollTop(messagesContainer[0].scrollHeight);
            }
        }
    }

    function loadDelete(chat) {
        chat.client.tinNhanDaXoa = function (id, kh, loai) {
            // Lấy danh sách tin nhắn trong phòng chat và hiển thị lên
            if (loai == true) {
                $('#contentMsg').empty();
                chat.server.getMessagesAdmin(id, kh);
            } else {
                chat.server.getMessages(id);
                $('#contentMsg').empty();
            }
        };
    }

    function loadGroup(chat) {
        var btnChatPhong = "btnChatPhong";
        var linkanh = "/Style/img/icon/icon-X.jpg";
        var title = "Xóa nhóm";
        chat.client.taoMoi = function (maphong, tenphong) {
            var href = "/Admin/TinNhanAdmin/DeletePhong?id=" + maphong;
            var ht = "<li><button type='button' class='btnChatPhong' data-id='" + maphong + "'>" +
                tenphong + "</button>" +
                "<a href='" + href + "' class='btnDelete'>" +
                "<img src='" + linkanh + "' class='btn-icon' id='btn-delete-" + maphong + "' title='" + title + "'/></a></li>"
            $('#Create_Room').append(ht);
        }
    }
</script>

